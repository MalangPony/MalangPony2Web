<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Noto+Sans+Mono:wght@100..900&display=swap" rel="stylesheet">
<link href="styles.css" rel="stylesheet" />
</head>

<body>
<div id="whole-screen-div" class="fullsize">
  
  <div id="l2d-container" >
    <canvas id="l2d-canvas"></canvas>
  </div>
  
  <div id="hmr-image-container">
    <img id="hmr-ground" src="MPN2-Prototype-Image-Hanmari4.png" style="z-index:3;opacity:0;">
    <img id="hmr-flash01" src="MPN2-Prototype-Image-Hanmari3.png" style="z-index:2;opacity:0;">
    <img id="hmr-base" src="MPN2-Prototype-Image-Hanmari2.png" style="z-index:1;">
  </div>
  <div id="stickies" class="fullsize" style="z-index:80;pointer-events:none;">
    <div id="sidebar-animation-container">
        <div id="sidebar-intro-anim" style="display:none;">
          <!--<img id="sidebar-intro-anim-image" src="MPN2-Prototype-Image-Scroll2.png" style="max-width:100%;max-height:100%;">-->
          <div id="letter-magic-spritesheet-animation"></div>
        </div>
      </div>
    <div id="sidebar-positioner" class="fullsize" style="z-index:10;">
      <div id="sidebar" style="pointer-events:auto;display:none;">
        <div onclick="sidebar_clicked('intro');" class="sb-link sb-link-active">
          <span class="lang-en">Home</span>
          <span class="lang-ko">홈</span>
        </div>
        <div onclick="sidebar_clicked('about');" class="sb-link sb-link-active">
          <span class="lang-en">About</span>
          <span class="lang-ko">개요</span>
        </div>
        <div onclick="sidebar_clicked('coc');" class="sb-link sb-link-active">
          <span class="lang-en">Code of Conduct</span>
          <span class="lang-ko">규칙</span>
        </div>
        <div onclick="sidebar_clicked('register');" class="sb-link sb-link-disabled">
          <span class="lang-en">Registration</span>
          <span class="lang-ko">등록</span>
        </div>
        <div onclick="sidebar_clicked('timetable');" class="sb-link sb-link-disabled">
          <span class="lang-en">Timetable</span>
          <span class="lang-ko">시간표</span>
        </div>
        <div onclick="sidebar_clicked('directions');" class="sb-link sb-link-disabled">
          <span class="lang-en">Directions</span>
          <span class="lang-ko">오시는 길</span>
        </div>
        <div onclick="sidebar_clicked('conbook');" class="sb-link sb-link-disabled">
          <span class="lang-en">Conbook</span>
          <span class="lang-ko">콘북</span>
        </div>
        <div onclick="sidebar_clicked('news');" class="sb-link sb-link-active">
          <span class="lang-en">News</span>
          <span class="lang-ko">소식</span>
        </div>
        <div onclick="sidebar_clicked('sponsors');" class="sb-link sb-link-disabled">
          <span class="lang-en">Sponsors</span>
          <span class="lang-ko">스폰서</span>
        </div>
        <div onclick="sidebar_clicked('involved');" class="sb-link sb-link-disabled">
          <span class="lang-en">Get Involved</span>
          <span class="lang-ko">모집</span>
        </div>
        <div onclick="sidebar_clicked('mascot');" class="sb-link sb-link-disabled">
          <span class="lang-en">Our Mascot</span>
          <span class="lang-ko">마스코트</span>
        </div>
        <div onclick="sidebar_clicked('staff');" class="sb-link sb-link-disabled">
          <span class="lang-en">Staff</span>
          <span class="lang-ko">스태프</span>
        </div>
      </div>
    </div>
    
    <div id="langswitch-positioner" class="fullsize"  style="z-index:5;">
      <div id="lang-btn"  style="pointer-events:auto;">
        <span class="lang-en">한국어</span>
        <span class="lang-ko">English</span>
      </div>
    </div>
    
    <div id="sb-button-positioner" class="fullsize" style="z-index:6;">
      <img src="MPN2-Prototype-Image-Scroll2.png" id="sb-btn" style="pointer-events:auto;display:none;"> 
    </div>
    
    <div id="debug-print-area" style="z-index:99;background-color:#00000040;color:#88FF8880;position:absolute;top:0;left:0;width:100px;height:50px;font-size:10px;font-family:monospace;font-weight:700;padding:4px;">
      <div id="debug-print-fps">-</div>
      <div id="debug-print-stars">-</div>
      <div id="debug-print-particles">-</div>
    </div>
  </div>
  <div id="content-scroller">
    <div id="mpn-logo-spacer">
      <div id="mpn_logo_container">
        <img id="logo-orig" src="MPN2-Prototype-Image-LogoPlain.png" style="z-index:3;opacity:0;">
        <img id="logo-flash01" src="MPN2-Prototype-Image-LogoGlow.png" style="z-index:2;opacity:0;">
        <img id="logo-base" src="MPN2-Prototype-Image-LogoDark.png" style="z-index:1;">
      </div>
    </div>
    <div id="scroll-inviter-container">
      <div id="scroll-inviter" style="font-size:4em;color:#FFF;">▼</div>
    </div>
    <div id="intro-content-container">
      
      <div id="screen-blanker"></div>
      
      <div id="afterscroll-content-container">
        <div id="page-intro" style="">
          <img id="logo-orig" src="MPN2-Prototype-Image-LogoPlain.png" style="margin-left:64px;margin-right:64px;max-width:min(600px , 100%);align-self:center;">
          
          <div style="font-size:3.0em;font-weight:700;color:#FFFFFF;text-align:center;">
            <span class="lang-en">Malfoy!!!</span>
            <span class="lang-ko">말포이!!!</span>
          </div>
          <div style="font-size:1.2em;font-weight:400;color:#FFFFFF;text-align:left;margin-top:32px;">
            <p>
              <span class="lang-en">Hello Bronies.</span>
              <span class="lang-ko">안녕하세요 브로니 여러분.</span>
              <br>
              <span class="lang-en">Come to our event!</span>
              <span class="lang-ko">와야겠지?</span>
              <br>
              <span class="lang-en">or I'll kill u</span>
              <span class="lang-ko">안오기만 해봐 그냥 콱</span>
            </p>
          </div>
          
          <div id="ticket"  style="pointer-events:auto;">
            <span class="lang-en">Registration!</span>
            <span class="lang-ko">지금 등록!</span>
          </div>
        </div>
        <div id="page-about" style="display:none;">
          <div style="margin-top:64px;font-size:3.0em;font-weight:700;color:#FFFFFF;text-align:center;">
            <span class="lang-en">About!!!</span>
            <span class="lang-ko">개요다!!!</span>
          </div>
        </div>
        <div id="page-coc" style="display:none;">
          <div style="margin-top:64px;font-size:3.0em;font-weight:700;color:#FFFFFF;text-align:center;">
            <span class="lang-en">Code of Conduct!!!</span>
            <span class="lang-ko">규칙이다!!!</span>
          </div>
        </div>
        <div id="page-news" style="display:none;">
          <div style="margin-top:64px;font-size:3.0em;font-weight:700;color:#FFFFFF;text-align:center;margin-bottom:32px;">
            <span class="lang-en">NEWS!!!</span>
            <span class="lang-ko">소식이다!!!</span>
          </div>
          <div id="bsky-outer">
            <bsky-embed 
              username="malangpony.bsky.social"
              load-more="true"
              disable-autoplay="true"
              ></bsky-embed>
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
  <div class="fullsize" id="parallax-image-container" style="z-index:-992;"></div>
  <canvas id="canvas-fireworks" class="fullsize" style="z-index:-996;"></canvas>
  <canvas id="canvas-stars" class="fullsize" style="z-index:-998;"></canvas>
  <div id="sky-bg" class="fullsize" style="z-index:-999;"></div>
</div>

<!-- 3rd party JS libraries -->
<script type="module" src="https://cdn.jsdelivr.net/npm/bsky-embed/dist/bsky-embed.es.js" async></script>
<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<script src="CubismSDK/live2dcubismcore.min.js"></script>
<!--
<script src="https://cdn.jsdelivr.net/npm/pixi.js@8.14.0/dist/pixi.min.js"></script>
-->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6/dist/browser/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
<!--
<script type="module">
import * as PIXI from 'pixi.js';
import { Live2DModel } from 'pixi-live2d-display';

// expose PIXI to window so that this plugin is able to
// reference window.PIXI.Ticker to automatically update Live2D models
window.PIXI = PIXI;

let ltc = document.getElementById("l2d-test-canvas");

(async function () {
  const app = new PIXI.Application({
    view: ltc
  });

  const model = await Live2DModel.from('hiyori_free_en/runtime/hiyori_free_t08.model3.json');

  app.stage.addChild(model);

  // transforms
  model.x = 100;
  model.y = 100;
  model.rotation = Math.PI;
  model.skew.x = Math.PI;
  model.scale.set(2, 2);
  model.anchor.set(0.5, 0.5);

  // interaction
  model.on('hit', (hitAreas) => {
    if (hitAreas.includes('body')) {
      model.motion('tap_body');
    }
  });
})();

</script>-->
<!--
<script>
const cubism2Model =
  "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/shizuku/shizuku.model.json";
const cubism4Model =
  "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json";

(async function main() {
  const app = new PIXI.Application({
    view: document.getElementById("l2d-test-canvas"),
    autoStart: true,
    resizeTo: window
  });

  const model2 = await PIXI.live2d.Live2DModel.from(cubism2Model);
  const model4 = await PIXI.live2d.Live2DModel.from(cubism4Model);

  app.stage.addChild(model2);
  app.stage.addChild(model4);

  model2.scale.set(0.3);
  model4.scale.set(0.25);

  model4.x = 300;
})();
</script>-->
<script>
const l2d_container = document.getElementById("l2d-container");
const l2d_canvas = document.getElementById("l2d-canvas");

const cubism4Model =
  "L2D-model/hiyori_free_t08.model3.json";

(async function main() {
  const app = new PIXI.Application({
    view:l2d_canvas,
    autoStart: true,
    backgroundAlpha: 0, 
    resizeTo:l2d_container
  });

  const model4 = await PIXI.live2d.Live2DModel.from(cubism4Model);

  app.stage.addChild(model4);

  model4.scale.set(0.25);
})();
</script>
<script>
// Tunable parameters
const OPTION_CAMERA_NUDGE_ENABLED=true;
const OPTION_HIDE_HANMARI_ON_NONINTRO_PAGES=false;
const OPTION_CAMERA_NUDGE_MOUSE_SENSITIVITY=1.0;
const OPTION_CAMERA_NUDGE_GYRO_SENSITIVITY=1.0;
const OPTION_STAR_DENSITY_MULTIPLIER=1.0;

const wsd = document.getElementById("whole-screen-div");
const canvas_fireworks = document.getElementById("canvas-fireworks");
const canvas_stars = document.getElementById("canvas-stars");
const container_stars = document.getElementById("container-stars");
const intro_content_container=document.getElementById("intro-content-container");

const hmr_image_base = document.getElementById("hmr-base");
const hmr_image_flash01 = document.getElementById("hmr-flash01");
const hmr_image_ground = document.getElementById("hmr-ground");

const logo_image_base = document.getElementById("logo-base");
const logo_image_flash01 = document.getElementById("logo-flash01");
const logo_image_orig = document.getElementById("logo-orig");

const content_scroller =document.getElementById("content-scroller");
const logo_spacer = document.getElementById("mpn-logo-spacer");
const screen_blanker=document.getElementById("screen-blanker");
const afterscroll_container=document.getElementById("afterscroll-content-container");

const sidebar = document.getElementById("sidebar");
const sia = document.getElementById("sidebar-intro-anim");
const siai =document.getElementById("sidebar-intro-anim-image");
const lmsa = document.getElementById("letter-magic-spritesheet-animation");

const lang_btn = document.getElementById("lang-btn");
const sb_btn = document.getElementById("sb-btn");

const parallax_image_container = document.getElementById("parallax-image-container");

const scroll_inviter_container = document.getElementById("scroll-inviter-container");
const scroll_inviter = document.getElementById("scroll-inviter");

const debug_print_fps=document.getElementById("debug-print-fps");
const debug_print_stars=document.getElementById("debug-print-stars");
const debug_print_particles=document.getElementById("debug-print-particles");

const hanmari_image_container = document.getElementById("hmr-image-container");

const star_density_reciprocal=10000/OPTION_STAR_DENSITY_MULTIPLIER; // One star every X pixels

// Pre-calculate star locations and attributes
let star_definitions=[];
let star_def_area_w=0;
let star_def_area_h=0;
let STARS_MAX_SCROLL=100;
let stars_scroll_pixels=0;

function spawn_stars(
    count,minX,maxX,minY,maxY){
    // min is inclusive, max is exclusive.
  for (let i=0;i<count;i++){
    star_definitions.push({
      "x":minX+(maxX-minX-1)*Math.random(),
      "y":minY+(maxY-minY-1)*Math.random(),
      "size":Math.random(),
      "sine_period":Math.random()*1.0+2.0,
      "sine_phase":Math.random()})
  }
}

function resize_star_area(new_w,new_h){
  console.log(`Star Area Changed: ${new_w} ${new_h}`)
  let old_area=star_def_area_h*star_def_area_w;
  
  if (new_w<star_def_area_w){
    // Contract X
    star_definitions=star_definitions.filter((sd)=>{
      return (sd.x<new_w);
    });
    star_def_area_w=new_w;
  }else if (new_w>star_def_area_w){
    //Expand X
    let new_area = new_w*star_def_area_h;
    let stars_to_spawn_r = (new_area-old_area)/star_density_reciprocal;
    let stars_to_spawn_i=Math.floor(stars_to_spawn_r);
    let stars_to_spawn_f=stars_to_spawn_r-stars_to_spawn_i;
    let stars_to_spawn=0;
    if (stars_to_spawn_f>Math.random()) stars_to_spawn=stars_to_spawn_i+1;
    else stars_to_spawn=stars_to_spawn_i;
    spawn_stars(
      stars_to_spawn,
      star_def_area_w,new_w,
      0,star_def_area_h);
    star_def_area_w=new_w;
  }
  
  if (new_h<star_def_area_h){
    // Contract Y
    star_definitions=star_definitions.filter((sd)=>{
      return (sd.y<new_h);
    });
    star_def_area_h=new_h;
  }else if (new_h>star_def_area_h){
    //Expand Y
    let new_area = new_h*star_def_area_w;
    let stars_to_spawn_r = (new_area-old_area)/star_density_reciprocal;
    let stars_to_spawn_i=Math.floor(stars_to_spawn_r);
    let stars_to_spawn_f=stars_to_spawn_r-stars_to_spawn_i;
    let stars_to_spawn=0;
    if (stars_to_spawn_f>Math.random()) stars_to_spawn=stars_to_spawn_i+1;
    else stars_to_spawn=stars_to_spawn_i;
    spawn_stars(
      stars_to_spawn,
      0,star_def_area_w,
      star_def_area_h,new_h);
    star_def_area_h=new_h;
  }
}


const sc2d = canvas_stars.getContext("2d");
function refresh_stars_canvas(dt){
  let w=canvas_stars.width;
  let h=canvas_stars.height;
  
  if ((w!=star_def_area_w) || ((h+STARS_MAX_SCROLL)!=star_def_area_h)){
    resize_star_area(w,h+STARS_MAX_SCROLL);
  }
  
  sc2d.clearRect(0,0,w,h);
  
  for (const sd of star_definitions){
    let x=sd.x;
    let y=sd.y-stars_scroll_pixels;
    if ((y<0) || (y>h)) continue;
    sd.sine_phase+=(dt/sd.sine_period);
    // Discard integer part
    sd.sine_phase=sd.sine_phase-Math.floor(sd.sine_phase);
    let sine_value = Math.sin(2*Math.PI*sd.sine_phase)*0.5+0.5;
    let size=1.0+sd.size*1.0+sine_value*0.5;
    draw_glowing_circle(
      sc2d,
      x,y,
      "hsla(  0,   0%, 100%, 0.9)",
      "hsla( 60, 100%,  50%, 0.3)",
      "hsla( 60, 100%, 100%, 0.0)",
      size,size*0.5,1.0+sine_value*2.0
    )
  
  }
  
  debug_print_stars.innerHTML="Stars x"+star_definitions.length
  
}

class Vector2{
  // 2D Vector. Immutable.
  #x;#y;
  constructor(x=0,y=0){
    this.#x=x;
    this.#y=y
  }
  get x(){ return this.#x; }
  get y(){ return this.#y; }
  add(v){
    return new Vector2(this.x+v.x,this.y+v.y);
  }
  invert(){
    return new Vector2(-this.x,-this.y);
  }
  subtract(v){
    return this.add(v.invert());
  }
  multiply(n){
    //console.log("V2/Mult "+n);
    return new Vector2(this.x*n,this.y*n);
  }
  divide(n){
    //console.log("V2/Div "+n);
    return this.multiply(1/n);
  }
  length(){
    return Math.sqrt(this.x*this.x+this.y*this.y);
  }
  normalize(){
    let len=this.length();
    if (len<0.0000001) return new Vector2(0,0);
    else return this.divide(len);
  }
  toString(){
    return "V2D("+this.x.toFixed(3)+","+this.y.toFixed(3)+")";
  }
  static random(){
    while (1){
      let v=new Vector2(Math.random()*2-1,Math.random()*2-1);
      if (v.length()>1.0) continue;
      return v;
    }
  }
  static ZERO = new Vector2(0,0);
}
class Vector3{
  // 3D Vector. Immutable.
  #x;#y;#z;
  constructor(x=0,y=0,z=0){
    this.#x=x;
    this.#y=y;
    this.#z=z;
  }
  get x(){ return this.#x; }
  get y(){ return this.#y; }
  get z(){ return this.#z; }
  add(v){
    return new Vector3(this.x+v.x,this.y+v.y,this.z+v.z);
  }
  invert(){
    return new Vector3(-this.x,-this.y,-this.z);
  }
  subtract(v){
    return this.add(v.invert());
  }
  multiply(n){
    return new Vector3(this.x*n,this.y*n,this.z*n);
  }
  divide(n){
    return this.multiply(1/n);
  }
  length(){
    return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);
  }
  normalize(){
    let len=this.length();
    if (len<0.0000001) return new Vector3(0,0,0);
    else return this.divide(len);
  }
  toString(){
    return "V3D("+this.x.toFixed(3)+","+this.y.toFixed(3)+","+this.z.toFixed(3)+")";
  }
  projectXY(){
    return new Vector2(this.x,this.y)
  }
  static random(){
    while (1){
      let v=new Vector3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1);
      if (v.length()>1.0) continue;
      return v;
    }
  }
  static ZERO = new Vector3(0,0,0);
}

class EntityPhysicsParameters{
  drag_coefficient_linear=0.0;
  drag_coefficient_quadratic=0.0;
  gravity=0.0;
}

class Entity{
  // Postion. Unit: Pixels.
  position = new Vector2();
  // Velocity. Unit: px/sec
  velocity = new Vector2();
  // Drag cofficients. Acceleration = Drag. Coeff * v^2
  drag_coefficient_linear = 0;
  drag_coefficient_quadratic = 0;
  // Gravitational acceleration towards +Y direction. px/s^2
  gravity = 0;
  constructor(){
    
  }
  tick(dt){
    if (isNaN(this.position.x)) return;
    //console.log("V1 "+this.velocity);
    //console.log("P1 "+this.position);
    let speed = this.velocity.length();
    let drag_force = 
      this.drag_coefficient_linear*speed+
      this.drag_coefficient_quadratic*speed*speed;
    let final_speed = speed - drag_force*dt;
    // Do not decelerate below zero speed.
    if (final_speed < 0) final_speed=0;
    //console.log("DT "+dt);
    //console.log("FS "+final_speed);
    //console.log("V2 "+this.velocity);
    //console.log("P2 "+this.position);
    //console.log("LE "+this.velocity.length());
    //console.log("NR "+this.velocity.normalize());
    this.velocity=this.velocity.normalize().multiply(final_speed);
    //console.log("V3 "+this.velocity);
    //console.log("P3 "+this.position);
    this.velocity=this.velocity.add(new Vector2(0,+this.gravity*dt));
    //console.log("V4 "+this.velocity);
    //console.log("P4 "+this.position);
    this.position=this.position.add(this.velocity.multiply(dt));
    //console.log("V5 "+this.velocity);
    //console.log("P5 "+this.position);
    
  }
  alive(){
    return true;
  }
  render(c2d){
    cs.context.fillStyle="#FF0000";
    let draw_position = this.position.add(c2d.offset);
    cs.context.fillRect(draw_position.x-2,draw_position.y-2,5,5);
  }
}

function draw_glowing_circle(
    c2d,
    x,y,
    color_inner,color_glow,color_edge,
    radius,border_feather,glow_radius){

  const total_r=radius+glow_radius;
  
  const gradient=c2d.createRadialGradient(
    x,y,0,
    x,y,total_r);
  let stop1=(radius-border_feather)/total_r;
  let stop2=(radius+border_feather)/total_r;
  let stop3=1.0;
  //console.log(color_inner);
  gradient.addColorStop(stop1,color_inner);
  //console.log(color_glow);
  gradient.addColorStop(stop2,color_glow);
  //console.log(color_edge);
  gradient.addColorStop(stop3,color_edge);
    
  c2d.fillStyle=gradient;
  c2d.beginPath();
  c2d.arc(x,y,total_r,0,2*Math.PI);
  c2d.fill();
}

class GlowingCircleEntity extends Entity{
  radius;
  inner_color;
  border_feather;
  glow_color;
  glow_radius;
  edge_color;
  life_size_power=1.0
  #life_fade=false;
  #lifetime;
  #remaining_life;
  set lifetime(t){
    this.#life_fade=true;
    this.#lifetime=t;
    this.#remaining_life=t;
  }
  tick(dt){
    super.tick(dt);
    if (this.#life_fade) this.#remaining_life-=dt;
  }
  alive(){
    if (this.#life_fade && this.#remaining_life<=0) return false;
    return true;
  }
  render(cs){
    let draw_position = this.position.add(cs.offset);
    
    let size_multiplier=1.0;
    if (this.#life_fade) size_multiplier=Math.pow(
      this.#remaining_life/this.#lifetime,
      this.life_size_power);
    //console.log("RL "+this.#remaining_life+" | SM "+size_multiplier);
    
    draw_glowing_circle(
      cs.context,
      draw_position.x,draw_position.y,
      this.inner_color,this.glow_color,this.edge_color,
      this.radius*size_multiplier,
      this.border_feather*size_multiplier,
      this.glow_radius*size_multiplier
    );
  }
}
class FireworkEntity extends GlowingCircleEntity{
  fuze_seconds;
  distance_travelled_without_particle=0;
  tick(dt){
    let old_position = this.position;
    super.tick(dt);
    let new_position=this.position;
    
    if (this.distance_travelled_without_particle>1000) //failsafe
      this.distance_travelled_without_particle=0
    
    if (this.fuze_seconds<0) return;
    this.fuze_seconds-=dt;
    if (this.fuze_seconds<0) {
      spawn_firework_burst(this.position,this.velocity);
    }else{
      // We are traveling - spawn some trail particles!
      this.distance_travelled_without_particle+=
        old_position.subtract(new_position).length();
      let particleN=0;
      while (this.distance_travelled_without_particle>0){
        this.distance_travelled_without_particle-=5;
        let e=new GlowingCircleEntity();
        e.position=new_position.subtract(old_position).multiply(Math.random()).add(old_position);
        let exhaust_velocity=this.velocity.normalize().multiply(-1*100);
        e.velocity=Vector2.random().multiply(150).add(exhaust_velocity);
        e.drag_coefficient_quadratic=0.1;
        e.gravity=PARTICLE_PHYSICS_GRAVITY;
        e.radius=0;
        e.lifetime=1.0;
        e.life_size_power=3.0;
        e.inner_color="#FFFFFF";
        e.border_feather=0;
        e.glow_color="#FFFFFF";
        e.glow_radius=5;
        e.edge_color="#FFFFFF00";
        entity_array.push(e);
      }
    }
  }
  alive(){
    return this.fuze_seconds>=0;
  }
}

let entity_array=[];

function offset_all_entities(dx,dy){
  for (const e of entity_array){
    e.position = e.position.add(new Vector2(dx,dy));
  }
}

let last_explosion_location=new Vector2();
const PARTICLE_PHYSICS_GRAVITY=300;
function spawn_firework_rocket(){
  let h=canvas_fireworks.height;
  let w=canvas_fireworks.width;
  
  planned_explosion_X=0;
  planned_explosion_Y=0;
  let avoidance_thresh=Math.min(h,w)*0.3;
  //let avoidance_thresh=w*0.5;
  for (let i=0;i<10;i++){
    planned_explosion_X=Math.random()*w;
    planned_explosion_Y=Math.random()*0.5*h;
    let explosion_candidate=new Vector2(planned_explosion_X,planned_explosion_Y);
    let distance=last_explosion_location.subtract(explosion_candidate).length();
    //console.log(distance);
    if (distance>avoidance_thresh) {
      last_explosion_location=explosion_candidate;
      break;
    }
  }
  
  let explosion_height=h-planned_explosion_Y;
  let seconds_to_apogee = Math.sqrt(explosion_height*2/PARTICLE_PHYSICS_GRAVITY);
  let vy=seconds_to_apogee*PARTICLE_PHYSICS_GRAVITY
  let fuze=seconds_to_apogee-Math.random()*0.5;
  
  
  let px = 0;
  let py = h;
  let vx=0;
  while (1){
    vx=(Math.random()*2-1)*100;
    px=planned_explosion_X-vx*fuze;
    if (px>0 && px<w){
      break;
    }
  }
  
  
  let e= new FireworkEntity();
  e.position=new Vector2(px,py);
  e.velocity=new Vector2(vx,-vy);
  e.gravity=PARTICLE_PHYSICS_GRAVITY;
  e.fuze_seconds=fuze;
  e.lifetime=fuze+0.01;
  e.radius=20;
  e.life_size_power=0.5;
  e.inner_color="#FFFFFF";
  e.border_feather=5;
  e.glow_color="#FF0000";
  e.glow_radius=30;
  e.edge_color="#FF000000";
  
  entity_array.push(e);
}

function spawn_firework_burst(center=null,initial_velocity=null){
  if (location===null){
    center=new Vector2(Math.random()*600,Math.random()*300);
  }
  if (initial_velocity===null){
    initial_velocity=new Vector2(0,0);
  }
  for (let i=0;i<50;i++){
    let e=new GlowingCircleEntity();
    e.position=center.add(Vector2.random().multiply(30));
    e.velocity=Vector2.random().multiply(1000).add(initial_velocity);
    e.drag_coefficient_quadratic=0.010;
    e.gravity=PARTICLE_PHYSICS_GRAVITY;
    e.radius=10;
    e.lifetime=2.0;
    e.life_size_power=3.0;
    e.inner_color="#FFFFFF";
    e.border_feather=2;
    e.glow_color="#00FF00";
    e.glow_radius=10;
    e.edge_color="#00FF0000";
    entity_array.push(e);
  }
  flash_anim_trigger();
}

class CanvasState{
  context;
  width;
  height;
  offset=new Vector2();
}

const fc2d = canvas_fireworks.getContext("2d");
let cs = new CanvasState();
cs.context=fc2d;
cs.offset=new Vector2(0,0);
function refresh_fireworks_canvas(dt){
  let w=canvas_fireworks.width;
  let h=canvas_fireworks.height;
  cs.width=w;
  cs.height=h;
  for (const e of entity_array){
    e.tick(dt);
  }
  
  entity_array=entity_array.filter((e)=>{
    if (!e.alive()) return false;
    if (e.position.x<0 || e.position.x>w) return false
    if (e.position.y<0 || e.position.y>h) return false
    return true;
  });
  
  //console.log("#Entities: "+entity_array.length);
  
  fc2d.clearRect(0,0,w,h);
  for (const e of entity_array){
    e.render(cs);
  }
  
  debug_print_particles.innerHTML="Particles x"+entity_array.length
}


let in_sky_mode=true;
function transition_sky(){
  in_sky_mode=true;
  let animation_out=[{ opacity: "1.0" },{ opacity: "0.0" } ];
  let animation_in=[{ opacity: "0.0" },{ opacity: "1.0" } ];
  let animation_opt={duration: 500,fill:"forwards"};
  logo_image_orig.animate(animation_out,animation_opt);
  hmr_image_ground.animate(animation_out,animation_opt);
  hmr_image_base.animate(animation_in,animation_opt);
  intro_content_container.classList.remove("activated");
  afterscroll_container.classList.remove("activated");
  lang_btn.classList.remove("activated");
  sb_btn.classList.remove("activated");
  if (mobile_mode) sidebar_button_hide_mobile();
  else sidebar_hide();
}
function transition_ground(){
  in_sky_mode=false;
  let animation_out=[{ opacity: "1.0" },{ opacity: "0.0" } ];
  let animation_in=[{ opacity: "0.0" },{ opacity: "1.0" } ];
  let animation_opt={duration: 500,fill:"forwards"};
  logo_image_orig.animate(animation_in,animation_opt);
  hmr_image_ground.animate(animation_in,animation_opt);
  hmr_image_base.animate(animation_out,animation_opt);
  //hmr_image_flash01.animate(animation_out,animation_opt);
  intro_content_container.classList.add("activated");
  afterscroll_container.classList.add("activated");
  lang_btn.classList.add("activated");
  sb_btn.classList.add("activated");
  window.setTimeout(()=>{
    if (!in_sky_mode) {
      if (mobile_mode) sidebar_button_animate_mobile();
      else sidebar_intro_animate();
    }},100);
}
/*
function sidebar_intro_animate(){
  sia.style.display="block";
  let anim1=sia.animate(
    [{opacity:0.0,transform:"translate(0,0)"},
     {opacity:0.5,transform:"translate(0,-50px)"},
     {opacity:1.0,transform:"translate(0,0)"}],
    {duration:700,delay:0,easing:"cubic-bezier(0,.3,1,.7)"})
  let anim3=siai.animate(
    [{transform:"scale(0.5) rotate(-180deg)"},
     {transform:"scale(1.2) rotate(360deg)"}],
     {duration:700,delay:0,easing:"linear"})
  let anim4=sidebar.animate(
    [{transform:"scale(0.0) rotate(-180deg)"},
     {transform:"scale(1.0) rotate(0)"}],
    {duration:300,delay:700,easing:"ease-out"})
  let anim5=sidebar.animate(
    [{maxHeight:"0"},
     {maxHeight:"calc(100vh - 64px)"}],
    {duration:1000,delay:1000,easing:"ease-in-out"})
  
  sidebar.style.display="none";
  sidebar.style.maxHeight="0";
  anim3.onfinish=(e)=>{
    sidebar.style.display="flex";
    sia.style.display="none";
  };
  anim5.onfinish=(e)=>{
    sidebar.style.maxHeight="calc(100vh - 64px)";
  }
}*/
function sidebar_magic_animate(){
  sia.style.display="block";
  
  const animation_frame_count=16;
  const actual_size_x=lmsa.clientWidth;
  const actual_size_y=lmsa.clientHeight;
  //console.log(`ASX ${actual_size_x} ASY ${actual_size_y} AFC ${animation_frame_count}`)
  lmsa.style.backgroundSize=`${actual_size_x*animation_frame_count}px ${actual_size_y}px`;
  
  let anim1=lmsa.animate(
    [{backgroundPositionX:"0"},{backgroundPositionX:"100%"}],
    {duration:1200,delay:0,easing:`steps(${animation_frame_count-1})`})
  let anim2=lmsa.animate(
    [{opacity:"0.0"},{opacity:"1.0"}],
    {duration:500,delay:0,easing:"linear"});
  let anim3=lmsa.animate(
    [{transform:"translate(0,+100px)"},{transform:"none"}],
    {duration:1000,delay:0,easing:"cubic-bezier(.18,.58,.6,.99)"})
  anim1.onfinish=(e)=>{
    sia.style.display="none";
  };
}
function sidebar_intro_animate(){
  sidebar_magic_animate();
  
  
  let anim4=sidebar.animate(
    [{transform:"scale(0.0)"},
     {transform:"scale(1.0)"}],
    {duration:400,delay:1100,easing:"ease-out"})
  let anim5=sidebar.animate(
    [{maxHeight:"0"},
     {maxHeight:"calc(100vh - 64px)"}],
    {duration:1000,delay:1500,easing:"ease-in-out"})
  
  sidebar.style.transform="scale(0)";
  sidebar.style.display="flex";
  sidebar.style.maxHeight="0";
  
  anim4.onfinish=(e)=>{
    sidebar.style.transform="none";
  };
  
  anim5.onfinish=(e)=>{
    sidebar.style.maxHeight="calc(100vh - 64px)";
  }
}
function sidebar_button_animate_mobile(){
  sidebar_magic_animate();
  
  let anim4=sb_btn.animate(
    [{transform:"scale(0.0)"},
     {transform:"scale(1.0)"}],
    {duration:400,delay:1100,easing:"ease-out"})
  
  sb_btn.style.display="block";
  sb_btn.style.transform="scale(0.0)";
  
  anim4.onfinish=(e)=>{
    sb_btn.style.transform="none";
  };  
}
function sidebar_button_hide_mobile(){
  let anim1=sb_btn.animate(
    [{marginLeft:"16px"},
     {marginLeft:"-160px"}],
    {duration:500,delay:0,easing:"ease-in"})
  anim1.onfinish = (e)=>{
    sb_btn.style.display="none";
    sb_btn.style.marginLeft="16px";
  }
}
function sidebar_intro_animate_mobile(){
  sidebar.style.transform="none";
  sidebar.style.display="flex";
  
  let anim4=sidebar.animate(
    [{opacity:"0"},
     {opacity:"1"}],
    {duration:300,delay:0,easing:"ease-out"});
  let anim2=sidebar.animate(
    [{maxWidth:"0"},
     {maxWidth:"100vw"}],
    {duration:300,delay:0,easing:"ease-in-out"});
  anim2.onfinish= ()=>{
    sidebar.style.maxWidth="100vw";
  }
  sidebar.style.maxHeight="0";
  let anim5=sidebar.animate(
    [{maxHeight:"0"},
     {maxHeight:"100vh"}],
    {duration:300,delay:000,easing:"ease-in-out"});
  anim5.onfinish= ()=>{
    sidebar.style.maxHeight="100vh";
  };
  let anim6=sb_btn.animate(
    [{opacity:1},
     {opacity:0}],
    {duration:300,delay:0,easing:"linear"})
  sb_btn.style.opacity=1;
  anim6.onfinish=(e)=>{
    sb_btn.style.opacity=0;
  };  
}
function sidebar_hide(){
  let anim1=sidebar.animate(
    [{marginLeft:"0"},
     {marginLeft:"-160px"}],
    {duration:500,delay:0,easing:"ease-in"})
  anim1.onfinish = (e)=>{
    sidebar.style.display="none";
    sidebar.style.marginLeft="0";
  }
}
function sidebar_hide_mobile(){
  let anim1=sidebar.animate(
    [{opacity:1},
     {opacity:0}],
    {duration:300,delay:0,easing:"linear"})
  anim1.onfinish = (e)=>{
    sidebar.style.display="none";
  }
  
  let anim4=sb_btn.animate(
    [{opacity:0},
     {opacity:1}],
    {duration:300,delay:0,easing:"linear"})
  sb_btn.style.opacity=0;
  anim4.onfinish=(e)=>{
    sb_btn.style.opacity=1;
  };  
}
function sidebar_hide_instant(){
  sidebar.style.display="none";
}
function flash_anim_trigger(){
  if (!in_sky_mode) return;
  let animation_kf=[{ opacity: "1.0" },{ opacity: "0.0" } ];
  let animation_opt={duration: 600+Math.random()*200,
     easing:"cubic-bezier(1.0, 0.0, 0.8, 1.0)",
     fill:"forwards",
     direction:"normal",
     iterations: 1};
  hmr_image_flash01.animate(animation_kf,animation_opt);
  logo_image_flash01.animate(animation_kf,animation_opt);
  /*container_ground.animate(
    [{ backgroundColor: "#144814" },
    { backgroundColor: "#104010" } ],
    animation_opt);*/
}

let fireworks_enabled=true;
function launch_firework_periodic(){
  if (fireworks_enabled) spawn_firework_rocket();
  window.setTimeout(launch_firework_periodic,Math.random()*2500+500);
}
launch_firework_periodic();

function polynomialEaseIn(x,power){
  return Math.pow(x,power);
}
function polynomialEaseOut(x,power){
  return 1-polynomialEaseIn(1-x,power)
}
function polynomialEase(x,power){
  if (x<0.5) return polynomialEaseIn(x*2,power)*0.5;
  else return polynomialEaseOut((x-0.5)*2,power)*0.5+0.5;
}
let last_t=NaN;
let camera_being_animated=false;
let camera_anim_position_start=null;
let camera_anim_position_end=null;
let camera_anim_time_duration=0;
let camera_anim_time_remaining=0;


let dbp=document.getElementById("debug-print");
// either "NO", "GYRO" or "MOUSE"
let CAMERA_NUDGE_MODE="MOUSE";

let mq_pointer=window.matchMedia("(pointer:fine)");
if (!mq_pointer.matches) CAMERA_NUDGE_MODE="GYRO";

if (!OPTION_CAMERA_NUDGE_ENABLED)
  CAMERA_NUDGE_MODE="NO";

console.log("Cam Nudge Mode: "+CAMERA_NUDGE_MODE);

function limit(low,x,high){
  if (x<low) return low;
  if (x>high) return high;
  return x
}
let gyro_data=Vector2.ZERO;
//https://stackoverflow.com/questions/69216465/the-simplest-way-to-solve-gimbal-lock-when-using-deviceorientation-events-in-jav#comment138275927_75897568
window.ondeviceorientation = (e) => {
  let alpha=e.alpha;
  let beta = e.beta;
  let gamma = e.gamma;
  
  const degtorad = Math.PI / 180; // Degree-to-Radian conversion
  let cX = Math.cos( beta  * degtorad );
  let cY = Math.cos( gamma * degtorad );
  let cZ = Math.cos( alpha * degtorad );
  let sX = Math.sin( beta  * degtorad );
  let sY = Math.sin( gamma * degtorad );
  let sZ = Math.sin( alpha * degtorad );

  let m13 = cY * sZ * sX + cZ * sY;
  let m23 = sZ * sY - cZ * cY * sX;

  gyro_data=new Vector2(m23,m13);
}

let mouse_location=new Vector2(wsd.clientWidth/2,wsd.clientHeight/2);
let mouse_screen_relative_location = Vector2.ZERO;
window.onmousemove= (e)=>{
  let screen_size = new Vector2(wsd.clientWidth,wsd.clientHeight);
  mouse_location=new Vector2(e.clientX,e.clientY);
  mouse_screen_relative_location = new Vector2(
    ((e.clientX/wsd.clientWidth)-0.5)*2,
    ((e.clientY/wsd.clientHeight)-0.5)*2
  );
}
let camera_nudge_lerped=Vector2.ZERO;

let frame_times=[];
function animationCallback(time) {
  frame_times.push(time);
  while (frame_times[0]+1000<time){
    let fps=(frame_times.length-1)/(time-frame_times[0])*1000;
    debug_print_fps.innerHTML="Anim "+fps.toFixed(2)+" FPS";
    frame_times=[];
  }
  

  if (canvas_fireworks.width!=wsd.clientWidth)
    canvas_fireworks.width=wsd.clientWidth;
  if (canvas_fireworks.height!=wsd.clientHeight)
    canvas_fireworks.height=wsd.clientHeight;
  
  if (canvas_stars.width!=wsd.clientWidth)
    canvas_stars.width=wsd.clientWidth;
  if (canvas_stars.height!=wsd.clientHeight)
    canvas_stars.height=wsd.clientHeight;
  
  
  if (isNaN(last_t)) last_t=time;
  let dt=(time-last_t)/1000;
  last_t=time;
  if (dt>1.0) dt=1.0;
  refresh_fireworks_canvas(dt);
  refresh_stars_canvas(dt);
  
  if (camera_being_animated){
    camera_anim_time_remaining-=dt;
    if (camera_anim_time_remaining<0){
      camera_being_animated=false;
      parallax_camera=camera_anim_position_end;
    }else{
      let anim_ratio = 1-(camera_anim_time_remaining/camera_anim_time_duration);
      anim_ratio=polynomialEase(anim_ratio,3);
      parallax_camera=camera_anim_position_end.subtract(camera_anim_position_start).multiply(anim_ratio).add(camera_anim_position_start);
    }
  }
  
  
  if (CAMERA_NUDGE_MODE==="NO"){
    camera_nudge_lerped = Vector2.ZERO;
  }else{
    let camera_nudge=Vector2.ZERO;
    if (CAMERA_NUDGE_MODE==="MOUSE"){
      camera_nudge= mouse_screen_relative_location.multiply(
        20*OPTION_CAMERA_NUDGE_MOUSE_SENSITIVITY);
      camera_nudge=new Vector2(camera_nudge.x,-camera_nudge.y);
    }
    else if (CAMERA_NUDGE_MODE==="GYRO"){
      camera_nudge= gyro_data.multiply(
        50*OPTION_CAMERA_NUDGE_GYRO_SENSITIVITY);
      camera_nudge=new Vector2(-camera_nudge.x,camera_nudge.y);
    }
    let lerp_fac=3.0;
    let lerp_raw_distance = camera_nudge.subtract(camera_nudge_lerped);
    let lerp_delta = lerp_raw_distance.multiply(Math.min(dt*lerp_fac,1.0));
    let speed = lerp_delta.length()/dt; //pixels per second
    if (speed<5) lerp_delta=Vector2.ZERO;//lerp_raw_distance;
    camera_nudge_lerped=camera_nudge_lerped.add(lerp_delta);
  }
  
  recalculate_parallax_images(
    new Vector3(
      parallax_camera.x+camera_nudge_lerped.x,
      (1-scroll_progress)*1000+camera_nudge_lerped.y,
      parallax_camera.z
    ));
  
  requestAnimationFrame(animationCallback);
}
requestAnimationFrame(animationCallback);

function camera_animate_to(loc){
  camera_being_animated=true;
  camera_anim_position_start=parallax_camera;
  camera_anim_position_end=loc;
  camera_anim_time_duration=1.0;
  camera_anim_time_remaining=camera_anim_time_duration;
}

//TODO change this JS-based animation to
// a CSS-based animation with "animation-timeline: scroll()" 
let scroll_progress=0;
let scroll_inviter_active=true;
function forceScrollDown(){
  if (sky_disabled) return;
  content_scroller.scrollTop=screen_blanker.clientHeight;
}
function forceScrollUp(){
  content_scroller.scrollTop=0;
}
content_scroller.addEventListener("scroll", (e) => { 
  //console.log("Scroll"+e);
  let scroll_progress_ratio=1;
  
  if (!sky_disabled) {
    let scroll_pixels=content_scroller.scrollTop;
    let scroll_maxium=screen_blanker.clientHeight;
    scroll_progress_ratio=scroll_pixels/scroll_maxium;
  }
  
  if (scroll_inviter_active && (scroll_progress_ratio>0.3)){
    scroll_inviter_container.animate(
    [{ opacity: "1.0" },{ opacity: "0.0" } ],
    {duration: 500,fill:"forwards"});
    scroll_inviter_active=false;
  }
  
  scroll_progress_ratio=Math.min(Math.max(scroll_progress_ratio,0),1);
  scroll_progress=scroll_progress_ratio;
  
  if (scroll_progress_ratio>0.95){
    if (in_sky_mode) transition_ground();
  }else{
    if (!in_sky_mode) transition_sky();
  }
  fireworks_enabled=scroll_progress_ratio<0.5;
  
  
  cs.offset=new Vector2(0,-scroll_progress_ratio*100);
  stars_scroll_pixels=scroll_progress_ratio*100;
});

let current_lang="ko";
let all_langs=["ko","en"];
function apply_lang(code){
  current_lang=code;
  for (const lang of all_langs){
    let all_elements=document.querySelectorAll(".lang-"+lang);
    for (const e of all_elements){
      if (lang===current_lang) e.style.display="inline";
      else e.style.display="none";
    }
  }
  // Save to cookie
  document.cookie="language="+code;
}

lang_btn.onclick= ()=>{
  if (current_lang=="ko") apply_lang("en");
  else apply_lang("ko");
}

let lang_from_cookie=null;
const cookieValue = document.cookie.split("; ").find((row) => row.startsWith("language="))?.split("=")[1];
console.log("language cookie value: "+cookieValue);
if (cookieValue!==undefined) {
  if (all_langs.includes(cookieValue)) lang_from_cookie=cookieValue;
  else console.log("Error: Language cookie value invalid!");
}

let lang_from_environment=null;
for (const lang of navigator.languages){
  for (const langcode of all_langs){
    if (lang.startsWith(langcode)){
      lang_from_environment=langcode;
      break;
    }
  }
  if (lang_from_environment !== null) break;
}
console.log("Language detected from environment: "+lang_from_environment);


if (lang_from_cookie !== null) {
  console.log("Apply language from cookie: "+lang_from_cookie);
  apply_lang(lang_from_cookie);
} else if (lang_from_environment !== null){
  console.log("Apply language from environment: "+lang_from_environment);
  apply_lang(lang_from_environment);
}else{
  console.log("Language fallback to EN");
  apply_lang("en");
}




class ParallaxImage{
  // Note that this is the coordinate of BOTTOM CENTER.
  location = new Vector3();
  dimensions = new Vector2();
  type;
  src;
  constructor(loc,dim,type,src){
    this.location=loc;
    this.dimensions=dim;
    this.type=type;
    this.src=src;
  }
  solve(camera_location = new Vector3()){
    let relative_location = this.location.subtract(camera_location);
    // 0% at 100, 100% at 500
    let opacity=(relative_location.z-100)/400;
    if (opacity<0) opacity=0;
    if (opacity>1) opacity=1;
    
    if (opacity<=0) return {"render":false};
    
    // intrinsic size at 100. 50% scale at 200.
    let xy_multiplier = 500/relative_location.z;
    
    let scaled_dim = this.dimensions.multiply(xy_multiplier);
    let offset_location = relative_location.multiply(xy_multiplier).projectXY();
    
    return {
      "render":true,
      "opacity":opacity,
      "x":offset_location.x,
      "y":offset_location.y+(relative_location.z)*0.3,
      "w":scaled_dim.x,
      "h":scaled_dim.y
    };
  }
  toString(){
    return "ParallaxImage(LOC="+this.location+", DIM="+this.dimensions+", TYP="+this.type+", SRC="+this.src+")";
  }
}

parallax_images=[
  // Ground
  new ParallaxImage(
    new Vector3(0,-300,1000),
    new Vector2(Infinity,-1),
    "solid","#0e3108"),
  //FS
  new ParallaxImage(
    new Vector3(-200,0,-100),
    new Vector2(200,200*(326/500)),
    "image","MPN2-Prototype-Image-D2489678.png"),
  //TS
  new ParallaxImage(
    new Vector3(200,0,0),
    new Vector2(200,200*(370/500)),
    "image","MPN2-Prototype-Image-D1408232.png"),
  //RD
  new ParallaxImage(
    new Vector3(100,0,200),
    new Vector2(200,200*(500/469)),
    "image","MPN2-Prototype-Image-D926915.png"),
  //Table
  new ParallaxImage(
    new Vector3(0,0,0),
    new Vector2(200,200*(500/1050)),
    "image","MPN2-Prototype-Image-D1467319-E1.png"),
  //Cannon
  new ParallaxImage(
    new Vector3(-400,0,300),
    new Vector2(200,200*(458/500)),
    "image","MPN2-Prototype-Image-D1718519.png"),
  
];
pimg_doms=[];

parallax_images.sort((a,b)=>{return b.location.z-a.location.z})

let parallax_camera = new Vector3(0,0,-500);

function populate_parallax_images(){
  // Clear all DOM
  parallax_image_container.replaceChildren();
  pimg_doms=[];
  
  // Add DOMs
  zi=0;
  for (const pimg of parallax_images){
    zi++;
    //console.log("Create PIMG "+pimg);
    let e=null;
    if (pimg.type=="image"){
      e=document.createElement("img");
      e.src=pimg.src;
    }else if (pimg.type=="solid"){
      e=document.createElement("div");
      e.style.backgroundColor=pimg.src;
    }else{
      console.log("ERROR 817");
    }
    e.style.position="absolute";
    e.style.zIndex=zi;
    e.style.display="none";
    parallax_image_container.appendChild(e);
    pimg_doms.push(e);
  }
}
populate_parallax_images();
function recalculate_parallax_images(camera_location){
  if (parallax_images.length != pimg_doms.length){
    console.log("ERROR 623")
  }
  let n=parallax_images.length;
  let containerW=parallax_image_container.clientWidth;
  let containerH=parallax_image_container.clientHeight;
  for (let i=0;i<n;i++){
    let dom = pimg_doms[i];
    let pimg=parallax_images[i];
    
    let solve_result=pimg.solve(camera_location);
    
    //console.log("SR "+i+" / "+JSON.stringify(solve_result));
    if (solve_result.render===false){
      dom.style.display="none";
    }
    else{
      dom.style.display="block";
      dom.style.opacity=solve_result.opacity;
      if (!Number.isFinite(pimg.dimensions.x)){
        dom.style.width="100%";
        dom.style.left="0";
      }else{

        dom.style.width=solve_result.w+"px";
        dom.style.left=(containerW/2+solve_result.x-solve_result.w/2)+"px";
        
      }
      if (!Number.isFinite(pimg.dimensions.y)){
        dom.style.height="100%";
        dom.style.bottom="0";
      }else if (pimg.dimensions.y<0){
        if (solve_result.y<0){
          dom.style.display="none";
        }else{
          dom.style.height=solve_result.y+"px";
          dom.style.bottom="0";
        }
      }else if (solve_result.h<0){
        dom.style.display="none";
      }else{
        dom.style.height=solve_result.h+"px";
        dom.style.bottom=solve_result.y+"px";
      }
      
    
    }
  }
}

/*
function recalculate_camera_position(){
  let scroll_amount=content_scroller.scrollTop;
  let scroll_maximum=intro_content_container.clientHeight-content_scroller.clientHeight;
  let scroll_bottom=scroll_maximum-scroll_amount;
  parallax_camera=new Vector3(
    Math.sin(Date.now()/500)*100,
    scroll_bottom,
    parallax_camera.z);
}
recalculate_parallax_images();
*/

function hide_hanmari(){
  hanmari_image_container.style.opacity=1.0;
  let anim3=hanmari_image_container.animate(
    [{ opacity: "1.0" },{ opacity: "0.0" }],
    {duration: 500,delay:0});
  anim3.onfinish= () => {
    hanmari_image_container.style.display="none";
  }
}
function hide_hanmari_instant(){
  hanmari_image_container.style.display="none";
}
function show_hanmari(){
  hanmari_image_container.style.display="block";
  hanmari_image_container.style.opacity=0.0;
  let anim3=hanmari_image_container.animate(
    [{ opacity: "0.0" },{ opacity: "1.0" }],
    {duration: 500,delay:0});
  anim3.onfinish= () => {
    hanmari_image_container.style.opacity=1.0;
  }
}
function show_hanmari_instant(){
  hanmari_image_container.style.display="block";
  hanmari_image_container.style.opacity=1.0;
}

let sky_disabled=false;
function sky_disable(){
  screen_blanker.style.display="none";
  mpn_logo_container.style.display="none";
  scroll_inviter_container.style.display="none";
  sky_disabled=true;
  forceScrollUp();
}
function sky_enable(){
  screen_blanker.style.display="block";
  mpn_logo_container.style.display="block";
  scroll_inviter_container.style.display="block";
  sky_disabled=false;
  forceScrollDown();
}

let currently_on_page="intro";
function page_transition_instant(name){

  if (name===currently_on_page) return;

  let last=document.getElementById("page-"+currently_on_page);
  if (last===null) return;

  let target=document.getElementById("page-"+name);
  if (target===null) return;

  last.style.display="none";
  target.style.display="flex";
  target.style.opacity=1.0;
  
  currently_on_page=name;
  if (currently_on_page==="intro") {
    sky_enable();
    show_hanmari_instant();
  }else {
    sky_disable();
    if (OPTION_HIDE_HANMARI_ON_NONINTRO_PAGES)
      hide_hanmari_instant();
  }
}
function page_transition(name){
  if (mobile_mode) sidebar_hide_mobile();
  
  //console.log("PT "+name)
  if (name===currently_on_page) return;
  //console.log("PT 1");
  let last=document.getElementById("page-"+currently_on_page);
  if (last===null) return;
  //console.log("PT 2");
  let target=document.getElementById("page-"+name);
  if (target===null) return;
  //console.log("PT 3");
  
  
  /*
  let anim1=last.animate(
    [{ opacity: "1.0" },{ opacity: "0.0" } ],
    {duration: 500});
  anim1.onfinish= () => {
    last.style.display="none";
    target.style.display="flex";
    target.style.opacity="0";
  }
  let anim2=target.animate(
    [{ opacity: "0.0" },{ opacity: "1.0" } ],
    {duration: 500,delay:500});
  anim2.onfinish= () => {
    target.style.opacity="1.0";
  }*/
  if (name!=="intro" && OPTION_HIDE_HANMARI_ON_NONINTRO_PAGES) 
    hide_hanmari();
    
    
  let anim3=intro_content_container.animate(
    [{ opacity: "1.0" },{ opacity: "0.0" }],
    {duration: 500,delay:0});
  anim3.onfinish= () => {
    last.style.display="none";
    target.style.display="flex";
    if (name==="intro") sky_enable();
    else sky_disable();
    if (name==="intro" && OPTION_HIDE_HANMARI_ON_NONINTRO_PAGES) 
      show_hanmari();
  }
  let anim4=intro_content_container.animate(
    [{ opacity: "0.0" },{ opacity: "1.0" }],
    {duration: 500,delay:500});
  anim4.onfinish= () => {
  }
  
  currently_on_page=name;
}

let camera_locations={
  intro:new Vector3(0,0,-500),
  about:new Vector3(200,0,-500),
  coc:new Vector3(0,0,-100),
  news:new Vector3(0,0,-800),
}
function sidebar_clicked(x){
  page_transition(x);
  let camloc=camera_locations[x];
  if (camloc === undefined) return;
  camera_animate_to(camloc);
  //window.location.hash = x;
  
  if (window.location.protocol==="file:"){
    console.log("Not rewriting URL because we're in a file URL.")
  }else{
    let url=window.location.origin+"/"+x;
    // Edge case for the intro page
    if (x==="intro") url=window.location.origin;
    window.history.pushState({},"",url);
  }
  

}





let mq_mobile=window.matchMedia("(width <= 640px)");

let mobile_mode=mq_mobile.matches;
function mobile_enter(){
  sidebar_hide_instant();
  sidebar_button_animate_mobile();
}
function mobile_leave(){
  if (!in_sky_mode) {
  sidebar_intro_animate();
  sidebar_button_hide_mobile();
  }
}

mq_mobile.onchange= ()=>{
  let match=mq_mobile.matches;
  mobile_mode=match;
  if (match) mobile_enter();
  else mobile_leave();
};
sb_btn.onclick=sidebar_intro_animate_mobile;

if (window.location.pathname != ""){
  let path_location=window.location.pathname.substring(1);
  
  let camloc=camera_locations[path_location];
  if (camloc !== undefined) {
    console.log("From URL, going to page: "+path_location);
    // Valid page location
    parallax_camera=camloc; // Jump camera
    forceScrollDown();
    page_transition_instant(path_location);
  }else{
    console.log("From URL, invalid page: "+path_location);
  }
}



</script>
</body>
</html>
